rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
  		allow read: if request.auth != null;
  		allow update: if request.auth.uid == userId || isAdmin();
  		allow create: if request.auth != null;
  		allow delete: if isAdmin();
		}
    
    match /users/{userId}/availability/{date} {
  		allow read: if request.auth != null && isStylist(userId);
  		allow write: if isAdmin() || (isEmpleado() && request.auth.uid == userId);
		}

    match /bookings/{bookingId} {
      allow read, write: if request.auth != null || isAdmin() || isEmpleado() || isUsuario();
    }
    
    match /services/{servicesId} {
  		allow read: if request.auth != null;
  		allow write: if isAdmin();
		}
    
    match /weeklyTemplates/{templateId} {
  		allow read: if request.auth != null;
		}

    match /users/{userId}/profile/info {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }
    
    match /users/{userId}/profile/{fileName} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isEmpleado() {
      return request.auth.token.role == 'empleado';
    }
    
    function isUsuario() {
      return request.auth.token.role == 'usuario';
    }
    
    function isStylist(targetId) {
  		return get(/databases/$(database)/documents/users/$(targetId)).data.role in ['empleado', 'admin'];
		}
  }
}
