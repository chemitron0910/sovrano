rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
  		allow read: if request.auth != null;
  		allow update: if request.auth.uid == userId || isAdmin();
  		allow create: if request.auth != null;
  		allow delete: if isAdmin();
		}
    
    match /users/{userId}/availability/{date} {
  		allow read, write: if isAdmin() || (isEmpleado() && request.auth.uid == userId);
      allow read, write: if isUsuario();
      allow read: if isGuest();
      allow update: if isGuest();
		}

    match /bookings/{bookingId} {
      allow create: if request.auth != null && (isAdmin() || isEmpleado() || isUsuario() || isGuest());
      allow read: if request.auth != null;
      allow update: if (
    		isAdmin() ||
    		(isUsuario() && request.auth.uid == resource.data.userId) ||
    		(isEmpleado() && request.auth.uid == resource.data.stylistId)
  		)
  		&&
      (    
    	request.resource.data.diff(resource.data).affectedKeys()
      	.hasOnly(["status", "cancelledAt"])
  		);
      allow delete: if isAdmin();
    }
    
    match /services/{servicesId} {
  		allow read: if request.auth != null;
  		allow write: if isAdmin();
		}
    
    match /weeklyTemplates/{templateId} {
  		allow read: if request.auth != null;
		}

    match /users/{userId}/profile/info {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }
    
    match /users/{userId}/profile/{fileName} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isEmpleado() {
      return request.auth.token.role == 'empleado';
    }
    
    function isUsuario() {
      return request.auth.token.role == 'usuario';
    }
    
    function isGuest() {
      return request.auth.token.role == 'guest';
    }
    
    function isStylist(targetId) {
  		return get(/databases/$(database)/documents/users/$(targetId)).data.role in ['empleado', 'admin'];
		}
  }
}
